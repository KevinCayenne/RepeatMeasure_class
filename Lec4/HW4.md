#### Homework: 請執行上面的兩段R程式，紫色部分目的為何，其結果可以對應到SAS的哪些output？

### 1. 
```R
# Random intercept model
setwd("G:/Repeated1062/0330")
pr <- read.csv("prlong.csv")
pr$sex <- ifelse(pr$Gender=="F",0,1)
X <- cbind(rep(1,108),pr$sex,pr$Age)
R <- diag(2.0495,108)
Z <- matrix(0,108,27)
for(i in 1:27){
  Z[(4*i-3):(4*i),i] <- 1
}
G <- diag(3.2668,27)
Y <- matrix(pr$y, ncol=1)
red <- solve(rbind(cbind(t(X) %*% solve(R) %*% X, t(X) %*% solve(R) %*% Z),cbind(t(Z) %*% solve(R) %*% X, (t(Z) %*% solve(R) %*% Z + solve(G)))))
```
$\begin{bmatrix}\widehat {\beta } \\\widehat {\gamma}\end{bmatrix} = \begin{bmatrix}X'R^{-1}X & X'R^{-1}Z \\Z'R^{-1}X & Z'R^{-1}Z+G^{-1}\end{bmatrix}^{-1} \begin{bmatrix} X 'R^{-1}y \\ Z'R^{-1}y \end{bmatrix}$

紫色部分為求出模型之固定效果與隨機效果之估計值和其標準誤差(黃色螢光部分)。

```R
> red %*% rbind(t(X) %*% solve(R) %*% Y, t(Z) %*% solve(R) %*% Y)
             [,1]
 [1,] 15.38569024 ## Intercept ## fixed effect estimate
 [2,]  2.32102273 ## GenderM ## fixed effect estimate
 [3,]  0.66018519 ## Age ## fixed effect estimate
 [4,] -1.10017278 ## Person 1 intercept ## random effect estimate ...
 [5,]  0.30451211 ## random effect estimate...
 [6,]  0.95282821
 [7,]  1.92530236
 [8,] -0.01964594
 [9,] -1.31627814
[10,]  0.30451211
[11,]  0.62867016
[12,] -1.31627814
[13,] -3.58538450
[14,]  3.22193456
[15,]  2.40417221
[16,] -1.37767171
[17,] -0.62130293
[18,]  1.43169806
[19,] -1.70182976
[20,]  1.21559269
[21,] -1.05351366
[22,] -0.94546098
[23,]  0.13506585
[24,]  3.91690978
[25,] -1.16156635
[26,] -0.62130293
[27,] -0.62130293
[28,] -0.08103951
[29,]  0.78338196
[30,] -1.70182976
```

$var\begin{bmatrix}\widehat {\beta } \\\widehat {\gamma}\end{bmatrix} = \begin{bmatrix}X'R^{-1}X & X'R^{-1}Z \\Z'R^{-1}X & Z'R^{-1}Z+G^{-1}\end{bmatrix}^{-1}$


```R
> sqrt(diag(red)) ## Std. Error
 [1] 0.89599173 0.76141960 0.06160658 0.83643614 0.83643614 0.83643614 0.83643614
 [8] 0.83643614 0.83643614 0.83643614 0.83643614 0.83643614 0.83643614 0.83643614
[15] 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046
[22] 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046 0.78702046
[29] 0.78702046 0.78702046
```

![52241476436](C:\Users\acer\AppData\Local\Temp\1522414764369.png)

![52241482216](C:\Users\acer\AppData\Local\Temp\1522414822167.png)

### 2. 

```R
# Random intercept and random slope model
R <- diag(1.7162,108)
Z <- matrix(0,108,54)
for(i in 1:27){
  Z[(4*i-3):(4*i),(2*i-1)] <- 1
  Z[(4*i-3):(4*i),(2*i)] <- seq(8,14,2)
}
G <- diag(0,54)
for(i in 1:27){
  G[(2*i-1):(2*i),(2*i-1):(2*i)] <- matrix(c(7.8233,-0.485,-0.485,0.05127),2,2)
}
red <- solve(rbind(cbind(t(X) %*% solve(R) %*% X, t(X) %*% solve(R) %*% Z),cbind(t(Z) %*% solve(R) %*% X, (t(Z) %*% solve(R) %*% Z + solve(G)))))
```

```R
> red %*% rbind(t(X) %*% solve(R) %*% Y, t(Z) %*% solve(R) %*% Y)
             [,1]
 [1,] 15.48975443
 [2,]  2.14541440
 [3,]  0.66018519
 [4,]  0.11185114
 [5,] -0.12268774
 [6,] -0.37061822
 [7,]  0.05450866
 [8,] -0.01389284
 [9,]  0.08274059
[10,]  2.30514824
[11,] -0.03979229
[12,]  1.43318911
[13,] -0.14280817
[14,] -0.07312965
[15,] -0.12599168
[16,]  0.62046679
[17,] -0.03709177
[18,]  2.38456549
[19,] -0.16953650
[20,]  0.32330435
[21,] -0.16263186
[22,] -2.31275349
[23,] -0.13320301
[24,]  2.62216499
[25,]  0.05331175
[26,]  0.96192401
[27,]  0.14389058
[28,] -1.58148036
[29,]  0.02195119
[30,] -0.83493909
[31,]  0.02435496
[32,]  3.20187398
[33,] -0.15493852
[34,] -2.15627706
[35,]  0.04447540
[36,]  1.03472316
[37,]  0.02495839
[38,] -1.40311768
[39,]  0.03606715
[40,]  0.37421724
[41,] -0.11800161
[42,] -1.07948282
[43,]  0.11835917
[44,]  3.04965757
[45,]  0.09373788
[46,]  0.38745345
[47,] -0.13962564
[48,] -1.82602410
[49,]  0.11595540
[50,] -5.59214714
[51,]  0.46403704
[52,]  0.51948941
[53,] -0.04982555
[54,] -1.11919145
[55,]  0.18323128
[56,] -0.96697504
[57,] -0.06544512
```

```R
> sqrt(diag(red))
 [1] 0.94430311 0.75751618 0.07125333 2.07585409 0.17947294 2.07585409 0.17947294
 [8] 2.07585409 0.17947294 2.07585409 0.17947294 2.07585409 0.17947294 2.07585409
[15] 0.17947294 2.07585409 0.17947294 2.07585409 0.17947294 2.07585409 0.17947294
[22] 2.07585409 0.17947294 2.07585409 0.17947294 2.06179329 0.17942123 2.06179329
[29] 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123
[36] 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329
[43] 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123
[50] 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329 0.17942123 2.06179329
[57] 0.17942123
```

![52242315956](C:\Users\acer\AppData\Local\Temp\1522423159568.png)

![52242321382](C:\Users\acer\AppData\Local\Temp\1522423213827.png)